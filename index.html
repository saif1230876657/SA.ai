<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Saif AI</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Aref+Ruqaa:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-color: #000000;
      --glass-bg: rgba(20, 20, 20, 0.75);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-main: #ffffff;
      --text-sec: #aaaaaa;
      --accent: #ffffff;
    }
    * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: var(--bg-color); color: var(--text-main); }
    
    /* Space Background */
    .space-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none; background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); }
    .moon { position: absolute; top: 5%; right: 10%; width: 80px; opacity: 0.8; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2)); }
    .star { position: absolute; background: white; border-radius: 50%; width: 2px; height: 2px; animation: twinkle 3s infinite ease-in-out; }
    .star:nth-child(1) { top: 20%; left: 20%; animation-delay: 0s; }
    .star:nth-child(2) { top: 40%; left: 80%; animation-delay: 1s; }
    .star:nth-child(3) { top: 60%; left: 10%; animation-delay: 2s; }
    .star:nth-child(4) { top: 10%; left: 50%; animation-delay: 1.5s; }
    .star:nth-child(5) { top: 80%; left: 70%; animation-delay: 0.5s; }
    @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

    /* Layout */
    .app-container { display: flex; flex-direction: column; height: 100%; position: relative; z-index: 1; }
    
    /* Header */
    .header {
        position: absolute; top: 0; left: 0; right: 0; height: 60px;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 20px; z-index: 100;
        background: transparent;
    }
    .brand { font-family: 'Aref Ruqaa', serif; font-size: 1.5rem; color: white; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
    .menu-btn { background: none; border: none; color: white; font-size: 1.4rem; cursor: pointer; }

    /* Chat Area */
    .chat-view { flex: 1; overflow-y: auto; padding: 70px 15px 180px 15px; scroll-behavior: smooth; position: relative; }
    
    /* Empty State (Astronaut) */
    .empty-state {
        position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
        text-align: center; width: 100%;
    }
    .astronaut-img { width: 140px; animation: float 6s ease-in-out infinite; margin-bottom: 20px; }
    .welcome-text { font-size: 1.1rem; color: rgba(255,255,255,0.8); }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

    /* Messages */
    .message { display: flex; flex-direction: column; margin-bottom: 20px; max-width: 85%; animation: fadeUp 0.3s ease; }
    .message.user { align-self: flex-end; align-items: flex-end; }
    .message.bot { align-self: flex-start; align-items: flex-start; }
    .msg-bubble { padding: 12px 16px; border-radius: 20px; line-height: 1.6; font-size: 0.95rem; position: relative; word-wrap: break-word; background: rgba(30, 30, 30, 0.8); backdrop-filter: blur(5px); border: 1px solid var(--glass-border); color: white; }
    .message.user .msg-bubble { background: rgba(255, 255, 255, 0.1); border-bottom-left-radius: 4px; }
    html[dir="ltr"] .message.user .msg-bubble { border-bottom-left-radius: 20px; border-bottom-right-radius: 4px; }
    .message.bot .msg-bubble { background: rgba(0, 0, 0, 0.6); }
    .msg-header { font-size: 0.7rem; color: #888; margin-bottom: 4px; margin-right: 8px; }

    /* Input Area - The "Capsule" */
    .input-area {
        position: absolute; bottom: 0; left: 0; right: 0;
        padding: 15px; background: linear-gradient(to top, rgba(0,0,0,1) 20%, transparent);
        z-index: 50;
    }
    .input-wrapper {
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 10px;
        position: relative;
        display: flex; flex-direction: column;
        transition: border-color 0.3s;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .input-wrapper:focus-within { border-color: rgba(255,255,255,0.3); }

    textarea {
        width: 100%; background: transparent; border: none;
        color: white; padding: 10px; resize: none;
        max-height: 120px; font-size: 1rem;
        margin-bottom: 40px; /* Space for buttons */
    }
    textarea::placeholder { color: rgba(255,255,255,0.4); }

    /* Buttons inside Input */
    .input-actions {
        position: absolute; bottom: 8px; left: 10px; right: 10px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .left-actions, .right-actions { display: flex; align-items: center; gap: 10px; }

    .icon-btn {
        width: 38px; height: 38px; border-radius: 50%;
        border: none; background: rgba(255,255,255,0.05);
        color: rgba(255,255,255,0.7);
        cursor: pointer; display: flex; justify-content: center; align-items: center;
        transition: 0.2s; font-size: 1.1rem;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.15); color: white; }
    .icon-btn.active-model { color: #ffeb3b; background: rgba(255, 235, 59, 0.1); border: 1px solid rgba(255, 235, 59, 0.3); }
    
    .send-btn {
        width: 40px; height: 40px; border-radius: 50%;
        background: white; color: black; border: none;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; font-size: 1.1rem; transition: transform 0.2s;
    }
    .send-btn:hover { transform: scale(1.05); }

    /* Image Preview */
    .img-preview { display: none; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .preview-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); }
    .sent-image { max-width: 100%; border-radius: 12px; margin-top: 5px; border: 1px solid rgba(255,255,255,0.2); }

    /* Sidebar */
    .sidebar {
        position: fixed; top: 0; right: -280px; width: 280px; height: 100%;
        background: #111; border-left: 1px solid #333; z-index: 1000;
        transition: right 0.3s; padding: 20px; display: flex; flex-direction: column;
    }
    .sidebar.open { right: 0; }
    html[dir="ltr"] .sidebar { right: auto; left: -280px; border-left: none; border-right: 1px solid #333; transition: left 0.3s; }
    html[dir="ltr"] .sidebar.open { left: 0; }
    
    .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #333; }
    .menu-item {
        background: transparent; border: none; color: #ddd;
        width: 100%; padding: 12px; text-align: right;
        border-radius: 8px; cursor: pointer; margin-bottom: 5px;
        display: flex; align-items: center; gap: 10px;
    }
    html[dir="ltr"] .menu-item { text-align: left; }
    .menu-item:hover { background: #222; }
    .menu-item i { width: 20px; text-align: center; }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 900; display: none; }
    .overlay.show { display: block; }

    @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Toast */
    .toast {
        position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
        background: rgba(30,30,30,0.9); color: white; padding: 8px 16px;
        border-radius: 20px; border: 1px solid #444; font-size: 0.85rem;
        opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2000;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>

<div class="space-background">
    <img src="https://i.postimg.cc/Y9qbgjmX/moon-PNG20.png" alt="Moon" class="moon">
    <div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div>
</div>

<div class="app-container">
    <header class="header">
        <button class="menu-btn" id="menuBtn"><i class="fas fa-bars"></i></button>
        <span class="brand">Saif AI</span>
        <div style="width: 24px;"></div> <!-- Spacer -->
    </header>

    <div class="chat-view" id="chatContainer">
        <div class="empty-state" id="emptyState">
            <img src="https://i.postimg.cc/15L2K4wT/1000137153.png" alt="Astronaut" class="astronaut-img">
            <div class="welcome-text" id="welcomeText">مرحباً، كيف يمكنني مساعدتك؟</div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <div class="img-preview" id="imgPreview"></div>
            <textarea id="userInput" rows="1" dir="auto" placeholder="اكتب رسالتك..."></textarea>
            
            <div class="input-actions">
                <div class="right-actions">
                    <button class="icon-btn" id="modelToggle" title="تبديل النموذج">
                        <i class="fas fa-bolt"></i>
                    </button>
                </div>
                
                <div class="left-actions">
                    <input type="file" id="fileInput" accept="image/*" hidden>
                    <button class="icon-btn" id="uploadBtn"><i class="fas fa-paperclip"></i></button>
                    <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar -->
<div class="overlay" id="overlay"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h3 id="menuTitle">القائمة</h3>
        <button class="menu-btn" id="closeSidebar"><i class="fas fa-times"></i></button>
    </div>
    <button class="menu-item" id="newChatBtn"><i class="fas fa-plus"></i> <span id="t_newChat">محادثة جديدة</span></button>
    <button class="menu-item" id="langBtn"><i class="fas fa-globe"></i> <span id="t_lang">اللغة: العربية</span></button>
    <button class="menu-item" id="shareBtn"><i class="fas fa-share-alt"></i> <span id="t_share">مشاركة</span></button>
    <button class="menu-item" id="clearChatBtn" style="color: #ff5c5c;"><i class="fas fa-trash"></i> <span id="t_delete">حذف المحادثة</span></button>
    <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 10px;">
        <span style="font-size: 0.8rem; color: #666;" id="t_history">السجل</span>
        <div id="historyList" style="margin-top: 10px;"></div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    // --- State & Config ---
    const state = {
        lang: localStorage.getItem('saif_lang') || 'ar',
        isThinking: false, // Default is Fast mode (false)
        chats: JSON.parse(localStorage.getItem('saif_chats_vold') || '[]'),
        currentChatId: null,
        typing: false
    };

    const translations = {
        ar: {
            welcome: "مرحباً، كيف يمكنني مساعدتك؟", placeholder: "اكتب رسالتك...",
            newChat: "محادثة جديدة", langName: "اللغة: العربية", share: "مشاركة التطبيق",
            delete: "حذف المحادثة", history: "السجل", you: "أنت",
            modeFast: "الوضع السريع مفعل", modeThink: "وضع التفكير العميق مفعل",
            shareMsg: "جرب مساعد سيف الذكي: https://apk.e-droid.net/apk/app3760290-c4w5f2.apk"
        },
        en: {
            welcome: "Hello, how can I help you?", placeholder: "Type a message...",
            newChat: "New Chat", langName: "Language: English", share: "Share App",
            delete: "Delete Chat", history: "History", you: "You",
            modeFast: "Fast Mode Active", modeThink: "Deep Thinking Mode Active",
            shareMsg: "Check out Saif AI: https://apk.e-droid.net/apk/app3760290-c4w5f2.apk"
        },
        fr: {
            welcome: "Bonjour, comment puis-je vous aider ?", placeholder: "Écrivez un message...",
            newChat: "Nouvelle discussion", langName: "Langue: Français", share: "Partager",
            delete: "Supprimer", history: "Historique", you: "Vous",
            modeFast: "Mode Rapide", modeThink: "Mode Pensée", shareMsg: "Découvrez Saif AI"
        },
        es: {
            welcome: "Hola, ¿cómo puedo ayudarte?", placeholder: "Escribe un mensaje...",
            newChat: "Nuevo chat", langName: "Idioma: Español", share: "Compartir",
            delete: "Eliminar", history: "Historial", you: "Tú",
            modeFast: "Modo Rápido", modeThink: "Modo Pensamiento", shareMsg: "Prueba Saif AI"
        },
        zh: {
            welcome: "你好，我能帮你什么？", placeholder: "输入消息...",
            newChat: "新聊天", langName: "语言: 中文", share: "分享",
            delete: "删除", history: "历史", you: "你",
            modeFast: "快速模式", modeThink: "深度思考模式", shareMsg: "查看 Saif AI"
        }
    };

    // --- Elements ---
    const $ = id => document.getElementById(id);
    const els = {
        input: $('userInput'), container: $('chatContainer'), empty: $('emptyState'),
        send: $('sendBtn'), upload: $('uploadBtn'), file: $('fileInput'),
        preview: $('imgPreview'), modelBtn: $('modelToggle'),
        sidebar: $('sidebar'), overlay: $('overlay')
    };
    let attachedImg = null;

    // --- Init ---
    function init() {
        applyLang(state.lang);
        loadChat(state.chats.length ? state.chats[0].id : null);
        
        // Event Listeners
        $('menuBtn').onclick = () => toggleSidebar(true);
        $('closeSidebar').onclick = els.overlay.onclick = () => toggleSidebar(false);
        els.modelBtn.onclick = toggleModel;
        els.send.onclick = sendMessage;
        els.upload.onclick = () => els.file.click();
        els.file.onchange = handleFile;
        els.input.addEventListener('keydown', e => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
        els.input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        $('newChatBtn').onclick = () => { loadChat(null); toggleSidebar(false); };
        $('clearChatBtn').onclick = deleteChat;
        $('langBtn').onclick = cycleLang;
        $('shareBtn').onclick = () => {
            navigator.clipboard.writeText(translations[state.lang].shareMsg);
            showToast("تم نسخ الرابط" + (state.lang === 'ar' ? "" : " (Link Copied)"));
        };
    }

    // --- Core Logic ---
    function toggleModel() {
        state.isThinking = !state.isThinking;
        const icon = els.modelBtn.querySelector('i');
        if (state.isThinking) {
            icon.className = "fas fa-brain";
            els.modelBtn.classList.add('active-model');
            showToast(translations[state.lang].modeThink);
        } else {
            icon.className = "fas fa-bolt";
            els.modelBtn.classList.remove('active-model');
            showToast(translations[state.lang].modeFast);
        }
    }

    async function sendMessage() {
        const text = els.input.value.trim();
        if ((!text && !attachedImg) || state.typing) return;
        
        state.typing = true;
        els.empty.style.display = 'none';
        
        // Render User Msg
        const userMsg = { role: 'user', content: text, image: attachedImg };
        appendMessage(userMsg);
        saveMsg(userMsg);

        // Reset Input
        els.input.value = ''; els.input.style.height = 'auto';
        attachedImg = null; els.preview.style.display = 'none'; els.preview.innerHTML = '';

        // Prepare Bot Msg
        const botDiv = document.createElement('div');
        botDiv.className = 'message bot';
        botDiv.innerHTML = `<div class="msg-header">Saif AI</div><div class="msg-bubble"><i class="fas fa-circle-notch fa-spin"></i></div>`;
        els.container.appendChild(botDiv);
        scrollToBottom();

        // Build Payload
        const systemText = state.isThinking 
            ? "You are Saif AI. Think step-by-step. Provide detailed, deep, and comprehensive analysis." 
            : "You are Saif AI. Be concise, direct, and fast. Give short and helpful answers.";
        
        const history = getHistoryContext();
        const payload = [
            { role: "system", content: systemText + ` Answer in ${state.lang === 'ar' ? 'Arabic' : 'the user language'}.` },
            ...history,
            { role: "user", content: text + (attachedImg ? " [Image Attached]" : "") }
        ];

        try {
            const res = await fetch('https://text.pollinations.ai/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ messages: payload, model: 'openai', seed: Math.floor(Math.random()*1000) })
            });
            const data = await res.text();
            
            // Typewriter
            const bubble = botDiv.querySelector('.msg-bubble');
            bubble.innerHTML = '';
            let i = 0;
            const speed = state.isThinking ? 25 : 8; // Slower for thinking feeling
            
            function type() {
                if(i < data.length) {
                    bubble.textContent += data.charAt(i);
                    i++;
                    scrollToBottom();
                    setTimeout(type, speed);
                } else {
                    state.typing = false;
                    saveMsg({ role: 'assistant', content: data });
                }
            }
            type();

        } catch (e) {
            botDiv.querySelector('.msg-bubble').textContent = "Error: Network issue.";
            state.typing = false;
        }
    }

    // --- Helpers ---
    function appendMessage(msg) {
        const div = document.createElement('div');
        div.className = `message ${msg.role === 'user' ? 'user' : 'bot'}`;
        let content = '';
        if(msg.image) content += `<img src="${msg.image}" class="sent-image"><br>`;
        if(msg.content) content += escapeHtml(msg.content);
        
        div.innerHTML = `
            ${msg.role === 'assistant' ? '<div class="msg-header">Saif AI</div>' : ''}
            <div class="msg-bubble">${content}</div>
        `;
        els.container.appendChild(div);
        scrollToBottom();
    }

    function saveMsg(msg) {
        if(!state.currentChatId) {
            state.currentChatId = Date.now();
            state.chats.unshift({ id: state.currentChatId, title: msg.content.substring(0,20) || "New Chat", messages: [] });
        }
        const chat = state.chats.find(c => c.id === state.currentChatId);
        if(chat) chat.messages.push(msg);
        localStorage.setItem('saif_chats_vold', JSON.stringify(state.chats));
        renderHistory();
    }

    function loadChat(id) {
        state.currentChatId = id;
        els.container.innerHTML = '';
        els.container.appendChild(els.empty);
        
        if(id) {
            const chat = state.chats.find(c => c.id === id);
            if(chat && chat.messages.length) {
                els.empty.style.display = 'none';
                chat.messages.forEach(appendMessage);
            }
        } else {
            els.empty.style.display = 'block';
        }
        renderHistory();
    }

    function renderHistory() {
        const list = $('historyList');
        list.innerHTML = '';
        state.chats.forEach(c => {
            const d = document.createElement('div');
            d.style.padding = '8px';
            d.style.cursor = 'pointer';
            d.style.color = '#888';
            d.style.fontSize = '0.9rem';
            d.textContent = c.title;
            d.onclick = () => { loadChat(c.id); toggleSidebar(false); };
            list.appendChild(d);
        });
    }

    function getHistoryContext() {
        if (!state.currentChatId) return [];
        const chat = state.chats.find(c => c.id === state.currentChatId);
        return chat ? chat.messages.slice(-8).map(m => ({role: m.role, content: m.content})) : [];
    }

    function handleFile(e) {
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = v => {
            attachedImg = v.target.result;
            els.preview.style.display = 'block';
            els.preview.innerHTML = `<img src="${attachedImg}" class="preview-thumb">`;
        };
        r.readAsDataURL(f);
        els.file.value = '';
    }

    function cycleLang() {
        const langs = ['ar', 'en', 'fr', 'es', 'zh'];
        let idx = langs.indexOf(state.lang);
        state.lang = langs[(idx + 1) % langs.length];
        applyLang(state.lang);
    }

    function applyLang(l) {
        localStorage.setItem('saif_lang', l);
        document.documentElement.lang = l;
        document.documentElement.dir = l === 'ar' ? 'rtl' : 'ltr';
        const t = translations[l];
        $('welcomeText').textContent = t.welcome;
        els.input.placeholder = t.placeholder;
        $('t_newChat').textContent = t.newChat;
        $('t_lang').textContent = t.langName;
        $('t_share').textContent = t.share;
        $('t_delete').textContent = t.delete;
        $('t_history').textContent = t.history;
    }

    function toggleSidebar(open) {
        if(open) {
            els.sidebar.classList.add('open');
            els.overlay.classList.add('show');
        } else {
            els.sidebar.classList.remove('open');
            els.overlay.classList.remove('show');
        }
    }

    function deleteChat() {
        if(state.currentChatId) {
            state.chats = state.chats.filter(c => c.id !== state.currentChatId);
            localStorage.setItem('saif_chats_vold', JSON.stringify(state.chats));
            loadChat(null);
            toggleSidebar(false);
        }
    }

    function showToast(txt) {
        const t = $('toast');
        t.textContent = txt;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    function scrollToBottom() { els.container.scrollTop = els.container.scrollHeight; }
    function escapeHtml(t) { return t ? t.replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }

    init();
</script>
</body>
</html>
